rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper to check if user is authenticated (Staff uses Email/Pass, Patient uses Anonymous)
    // We assume Staff has a specific email domain or UID, but for this demo we'll assume
    // any authenticated user with email/password is staff, and anonymous is patient.
    // Actually, we can check provider.
    
    // スタッフ判定
// セキュリティ強化: 指定されたメールアドレスを持つユーザーのみを許可
function isStaff() {
  return request.auth != null 
    && request.auth.token.firebase.sign_in_provider != 'anonymous'
    && request.auth.token.email in ['nssu.kenkyu@gmail.com', 'nssu.scc@gmail.com'];
}

// 患者データ
match /patients/{patientId} {
  allow read, write: if isStaff();
  
  // 新規作成は誰でも許可（ただし適切な初期データが必要）
  allow create: if request.auth != null;
  
  // 読み取り許可:
  // 1. 文書が存在しない（存在確認のため）
  // 2. 自分のデータ（firebaseUidが一致）
  // 3. 所有者が決まっていない（firebaseUidがない） -> レガシー/未連携データ
  //    ※セキュリティ上は好ましくないが、既存フロー（ID+氏名入力）維持のため残す。
  //    ただし、書き込み側で「乗っ取り」を防ぐ。
  allow read: if request.auth != null && (
    resource == null || 
    resource.data.firebaseUid == request.auth.uid || 
    !('firebaseUid' in resource.data) ||
    resource.data.firebaseUid == null
  );

  // 更新許可:
  // 1. 自分が所有者の場合 (既存の所有者)
  // 2. まだ所有者がおらず、今回自分が所有者になろうとしている場合 (claims access)
  //    条件: 元のfirebaseUidが空 AND 新しいfirebaseUidが自分のUID
  allow update: if request.auth != null && (
    (resource.data.firebaseUid == request.auth.uid) ||
    (
      (!('firebaseUid' in resource.data) || resource.data.firebaseUid == null) &&
      request.resource.data.firebaseUid == request.auth.uid
    )
  );
}

// 来院データ
match /visits/{visitId} {
  // スタッフは全操作OK
  allow read, write: if isStaff();
  
  // 患者は作成のみOK
  allow create: if request.auth != null;
  
  // 一覧取得(List)はスタッフのみ。
  allow list: if isStaff();

  // 個別の取得(Get)
  // 1. 自分がスタッフである
  // 2. その来院記録の所有者である（firebaseUid が一致）
  //    ※既存データに firebaseUid がない場合、古いルールでは誰でも見れたが、
  //      セキュリティ強化のため「自分のもの」と証明できる場合のみ許可する方針へ変更。
  //      ただし、既存の運用に影響が出ないか注意が必要だが、
  //      作成時に firebaseUid を保存するようにコード修正済み。
  allow get: if request.auth != null && (
    resource.data.firebaseUid == request.auth.uid
  );
}

match /publicStatus/today {
  allow read: if true;
  allow write: if isStaff();
}
} }
