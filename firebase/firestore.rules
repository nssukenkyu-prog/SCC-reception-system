rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper to check if user is authenticated (Staff uses Email/Pass, Patient uses Anonymous)
    // We assume Staff has a specific email domain or UID, but for this demo we'll assume
    // any authenticated user with email/password is staff, and anonymous is patient.
    // Actually, we can check provider.
    
    // Common helpers
    function isStaff() {
      // For this prototype, we assume any Email/Password login is staff
      // Real prod: check specific email domain or UID list
      return request.auth != null && request.auth.token.firebase.sign_in_provider != 'anonymous';
    }

    match /patients/{patientId} {
      // Staff can do anything
      allow read, write: if isStaff();
      
      // Patient can create their own record or read it
      // Since we don't always know patientId == auth.uid (we map them), 
      // we allow create if auth is strict, but let's allow any auth for now as long as they authenticate
      // Allow create by authenticated users
      allow create: if request.auth != null;
      
      // Allow read if:
      // 1. Doc doesn't exist (resource == null) - needed for existence check
      // 2. User owns the doc (firebaseUid match)
      // 3. Doc is unclaimed (firebaseUid missing or null)
      allow read: if request.auth != null && (
        resource == null ||
        resource.data.firebaseUid == request.auth.uid || 
        !('firebaseUid' in resource.data) ||
        resource.data.firebaseUid == null
      );

      // Allow update only if user owns it or it's unclaimed
      allow update: if request.auth != null && (
        resource.data.firebaseUid == request.auth.uid || 
        !('firebaseUid' in resource.data) ||
        resource.data.firebaseUid == null
      );
    }

    match /visits/{visitId} {
      // Staff
      allow read, write: if isStaff();
      
      // Patient: can create a visit for themselves
      allow create: if request.auth != null;
      
      // Patient: can read only their own visits (assumes we store uid or lineUserId on visit? we store patientId)
      // Querying visits requires composite index if we filter by field not in rules
      // For simplicity in this LITE version, allow read if auth - needed for "checkin check"
      allow read: if request.auth != null;
    }

    match /publicStatus/today {
      allow read: if true;
      allow write: if isStaff();
    }
  }
}
