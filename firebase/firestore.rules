rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper to check if user is authenticated (Staff uses Email/Pass, Patient uses Anonymous)
    // We assume Staff has a specific email domain or UID, but for this demo we'll assume
    // any authenticated user with email/password is staff, and anonymous is patient.
    // Actually, we can check provider.
    
    // Common helpers
    // Common helpers
    function isStaff() {
      // Security Enhancement: Only allow specific domains or emails logic
      // For this LITE version, we check that auth is NOT anonymous (so must be email/pass)
      // AND optionally check domain if needed.
      // TODO: Replace with your specific email or domain for higher security.
      // e.g. return request.auth.token.email.matches('.*@example.com');
      
      return request.auth != null 
        && request.auth.token.firebase.sign_in_provider != 'anonymous'
        // && request.auth.token.email == 'kedoinhayato_1@example.com' // UNCOMMENT TO LOCK TO YOUR EMAIL
        ;
    }

    match /patients/{patientId} {
      // Staff can do anything
      allow read, write: if isStaff();
      
      // Patient can create their own record or read it
      // Since we don't always know patientId == auth.uid (we map them), 
      // we allow create if auth is strict, but let's allow any auth for now as long as they authenticate
      // Allow create by authenticated users
      allow create: if request.auth != null;
      
      // Allow read if:
      // 1. Doc doesn't exist (resource == null) - needed for existence check
      // 2. User owns the doc (firebaseUid match)
      // 3. Doc is unclaimed (firebaseUid missing or null)
      allow read: if request.auth != null && (
        resource == null ||
        resource.data.firebaseUid == request.auth.uid || 
        !('firebaseUid' in resource.data) ||
        resource.data.firebaseUid == null
      );

      // Allow update only if user owns it or it's unclaimed
      allow update: if request.auth != null && (
        resource.data.firebaseUid == request.auth.uid || 
        !('firebaseUid' in resource.data) ||
        resource.data.firebaseUid == null
      );
    }

    match /visits/{visitId} {
      // Staff
      allow read, write: if isStaff();
      
      // Patient: can create a visit for themselves
      allow create: if request.auth != null;
      
      // Patient: CANNOT list all visits (prevent leakage)
      // They can only GET a specific visit if they know the ID (which they get after check-in)
      allow list: if isStaff();
      allow get: if request.auth != null;
    }

    match /publicStatus/today {
      allow read: if true;
      allow write: if isStaff();
    }
  }
}
